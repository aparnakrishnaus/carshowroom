{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile | Car Showroom</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #000;
      color: #e0e0e0;
      font-family: 'Poppins', sans-serif;
    }

    html,
    body {
      overflow-x: hidden;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      background: #1a1a1a;
      border-radius: 16px;
      padding: 1.5rem 2rem;
      transition: all 0.3s ease;
      border: 2px solid #444444;
    }

    .profile-header img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #c0c0c0;
      box-shadow: 0 0 8px rgba(192, 192, 192, 0.3);
    }

    .profile-header .info {
      flex: 1;
    }

    .profile-header .info h4 {
      font-size: 1.4rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.3rem;
      font-family: 'Cinzel Decorative', serif;
    }

    .profile-header .info p {
      color: #b0b0b0;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
    }

    .edit-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #ffffff;
      color: #000;
      border: none;
      padding: 0.5rem 1.1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: unset;
    }

    .edit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
    }

    #profileTabs {
      border-bottom: 2px solid #444444;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      box-shadow: 0 3px 10px rgba(255, 255, 255, 0.06);
      display: flex;
      justify-content: flex-start;
      gap: 0.3rem;
    }

    #profileTabs .nav-item {
      margin-right: 0.3rem;
    }

    #profileTabs .nav-link {
      color: #c0c0c0;
      font-weight: 500;
      font-size: 0.95rem;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      transition: all 0.3s ease;
    }

    #profileTabs .nav-link:hover {
      color: #ffffff;
      background: rgba(192, 192, 192, 0.08);
    }

    #profileTabs .nav-link.active {
      color: #000;
      background: #ffffff;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(192, 192, 192, 0.3);
    }

    #profileTabs .nav-link.active:first-child {
      border-top-left-radius: 10px;
    }

    #profileTabs .nav-link.active:last-child {
      border-top-right-radius: 10px;
    }

    .tab-content {
      margin-top: 1rem;
    }

    .tab-content .card {
      border-radius: 16px;
      background: #1a1a1a;
      box-shadow: 0 4px 14px rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
      border: 1px solid #555555;
    }

    .tab-content .card:hover {
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1);
    }

    .tab-content h5 {
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1.2rem;
      border-bottom: 1px solid #c0c0c0;
      display: inline-block;
      padding-bottom: 4px;
    }

    .tab-content p {
      color: #c0c0c0;
      font-size: 0.95rem;
      margin-bottom: 0.6rem;
    }

    table.table {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #555555;
    }

    table thead {
      background: linear-gradient(135deg, #555555, #b0b0b0);
      color: #fff;
    }

    table th,
    table td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.93rem;
    }

    table tbody tr:hover {
      background-color: rgba(192, 192, 192, 0.08);
    }

    #wishlist .card {
      border: 1px solid #555555;
      border-radius: 12px;
      box-shadow: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    #wishlist .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(255, 255, 255, 0.08);
    }

    #wishlist img {
      max-height: 150px;
      object-fit: cover;
    }

    #wishlist .btn-outline-danger {
      border-radius: 8px;
      font-size: 0.85rem;
      border-color: #b0b0b0;
      color: #b0b0b0;
    }

    form label {
      font-weight: 500;
      color: #d0d0d0;
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid #555555;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-control:focus {
      border-color: #b0b0b0;
      box-shadow: 0 0 0 3px rgba(192, 192, 192, 0.2);
    }

    .btn-outline-primary {
      border-color: #b0b0b0;
      color: #b0b0b0;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background: white;
      color: #000;
      border-color: transparent;
    }

    .text-muted {
      font-style: italic;
      color: #888 !important;
    }

    #editProfileModal .modal-content {
      background: #1a1a1a;
      border-radius: 16px;
      border: 1px solid rgb(253, 249, 249);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #editProfileModal .modal-header {
      background: rgb(26, 26, 26);
      color: #fff;
      border-bottom: none;
      padding: 1rem 1.5rem;
    }

    #editProfileModal .modal-title {
      font-weight: 600;
      font-size: 1.2rem;
    }

    #editProfileModal .btn-close-white {
      filter: brightness(0) invert(1);
    }

    #editProfileModal .modal-body {
      background: #2a2a2a;
      border-radius: 0 0 16px 16px;
      padding: 1.5rem;
    }

    #editProfileModal label {
      font-weight: 500;
      color: #d0d0d0;
      margin-bottom: 0.3rem;
    }

    #editProfileModal .form-control {
      border-radius: 8px;
      border: 1px solid #555555;
      padding: 0.55rem 0.75rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    #editProfileModal .form-control:focus {
      border-color: #b0b0b0;
      box-shadow: 0 0 0 3px rgba(192, 192, 192, 0.2);
    }

    #editProfileModal .modal-footer {
      background: #1f1f1f;
      padding: 1rem 1.5rem;
    }

    #editProfileModal .btn-outline-secondary {
      border-radius: 8px;
      color: #c0c0c0;
      border-color: #555555;
      transition: all 0.3s ease;
    }

    #editProfileModal .btn-outline-secondary:hover {
      background: white;
      color: #000;
    }

    #editProfileModal .btn-outline-primary {
      border-color: #b0b0b0;
      color: #b0b0b0;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    #editProfileModal .btn-outline-primary:hover {
      background: white;
      color: #090909;
      border-color: transparent;
    }

    #editProfileModal input[type="file"] {
      padding: 0.4rem;
    }

    .modal.fade .modal-dialog {
      transform: scale(0.9);
      transition: all 0.3s ease;
    }

    .modal.show .modal-dialog {
      transform: scale(1);
    }


    #password input {
      background: #111111;
      border: 1px solid #555555;
      border-radius: 10px;
      color: #f0f0f0;
      padding: 0.6rem 0.8rem;
      width: 100%;
      font-size: 0.95rem;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
    }

    #password input:focus {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
      outline: none;
    }

    #password .form-label {
      color: #c0c0c0;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .tab-pane .alert {
      margin-bottom: 1rem;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    #close_btn {
      position: absolute;
      top: 0.6rem;
      right: 0.8rem;
      background: none !important;
      border: none;
      font-size: 1.1rem;
      color: #080808;
      opacity: 0.8;
      cursor: pointer;
      z-index: 10;
    }

    #close_btn:focus,
    #close_btn:active {
      outline: none !important;
      box-shadow: none !important;
    }

    .tab-pane .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .tab-pane .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    #update-btn:focus,
    #update-btn:active {
      outline: none !important;
      box-shadow: none !important;
      background-color: white !important;
    }

    .my-bookings {
      font-family: 'Poppins', sans-serif;
      background-color: #0b0b0b;
      color: #f0f0f0;
    }

    .filter-btn {
      background: transparent;
      border: 1px solid #444;
      color: #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      margin: 0 4px 1.2rem 0;
      font-size: 0.85rem;
      transition: 0.2s;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: #f1f1f1;
      color: #000;
    }

    .bookings-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      overflow-x: hidden;
    }

    .booking-item {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      border-bottom: 1px solid rgb(98, 97, 97);
      margin-bottom: 10px;
    }

    .car-image {
      flex: 0 0 160px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .car-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .booking-details {
      flex: 1;
      min-width: 200px;
      margin-bottom: 5px;
    }

    .booking-details p {
      margin: 0.2rem 0;
      font-size: 0.9rem;
      color: #ddd;
    }

    .booking-action {
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
    }

    .remove-btn {
      background: #ff4444;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: 0.3s;
    }

    .remove-btn:hover {
      background: #ff2222;
    }

    @media (max-width: 992px) {
      .profile-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 1.2rem;
        gap: 1rem;
      }

      .profile-header img {
        width: 90px;
        height: 90px;
      }

      .info h4 {
        font-size: 1.1rem;
      }

      .info p {
        font-size: 0.9rem;
      }

      .edit-btn {
        font-size: 0.85rem;
        padding: 0.45rem 0.9rem;
      }

      #profileTabs {
        flex-wrap: wrap;
        justify-content: center;
        text-align: center;
        gap: 0.5rem;
        padding: 0.5rem;
      }

      #profileTabs .nav-link {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
      }

      .tab-content .card {
        padding: 1.2rem;
      }

      table th,
      table td {
        font-size: 0.85rem;
      }

      .bookings-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .booking-item {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 1rem;
      }

      .car-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        margin-bottom: 1rem;
      }

      .car-image img {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }

      .booking-details {
        padding: 0.5rem 0;
      }

      .booking-action {
        margin-top: 0.6rem;
        width: 100%;
      }

      .remove-btn {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .booking-item {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .car-image {
        width: 100%;
        max-width: 250px;
        height: auto;
      }

      .car-image img {
        border-radius: 10px;
      }

      .booking-details {
        width: 100%;
        margin-top: 0.8rem;
      }

      .booking-action {
        width: 100%;
        margin-top: 0.8rem;
        justify-content: center;
      }

      .remove-btn {
        width: 100%;
      }
    }

    @media (max-width: 600px) {
      body {
        font-size: 0.9rem;
      }

      .container {
        padding: 0 1rem;
      }

      .profile-header {
        padding: 1rem;
        border-radius: 10px;
      }

      .profile-header .info h4 {
        font-size: 1rem;
      }

      .edit-btn {
        width: 100%;
        margin-top: 0.5rem;
      }

      #profileTabs {
        flex-direction: column;
        align-items: stretch;
        gap: 0.4rem;
      }

      #profileTabs .nav-link {
        width: 100%;
        font-size: 0.85rem;
        padding: 0.5rem 0.8rem;
      }

      .tab-content h5 {
        font-size: 1rem;
        text-align: center;
      }

      .filter-btn {
        font-size: 0.8rem;
        padding: 5px 10px;
        margin-bottom: 0.5rem;
      }

      .booking-details p {
        font-size: 0.85rem;
      }

      .car-name {
        font-size: 0.95rem;
      }

      #editProfileModal .modal-dialog {
        margin: 0.8rem;
      }

      #editProfileModal .modal-content {
        border-radius: 12px;
      }

      #editProfileModal .modal-body {
        padding: 1rem;
      }

      #editProfileModal input,
      #editProfileModal label {
        font-size: 0.85rem;
      }

      #update-btn {
        width: 100%;
      }
    }

    @media (max-width: 400px) {
      .profile-header img {
        width: 75px;
        height: 75px;
      }

      .edit-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
      }

      .booking-item {
        padding: 0.8rem;
      }

      .booking-details p {
        font-size: 0.8rem;
      }

      .remove-btn {
        font-size: 0.75rem;
      }
    }

    .heart-pop {
      animation: heart-pop 0.3s ease forwards;
    }

    @keyframes heart-pop {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.2);
      }

      100% {
        transform: scale(1);
      }
    }

    .review-modal .modal-backdrop.show {
      opacity: 0.85;
      background-color: rgba(0, 0, 0, 0.8);
    }

    .review-modal .modal-content {
      background-color: #fff;
      color: #333;
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }

    .review-modal .modal-header {
      background-color: #f9f9f9;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }

    .review-modal .modal-title {
      font-weight: 600;
      color: #111;
    }

    .review-modal .btn-close {
      filter: invert(0.6);
    }

    .review-modal .modal-body {
      padding: 1.5rem 1.8rem;
    }

    .review-modal .form-label {
      font-weight: 500;
      color: #111;
    }

    .review-modal select.form-select,
    .review-modal textarea.form-control {
      border-radius: 10px;
      border: 1px solid #ddd;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .review-modal select.form-select:focus,
    .review-modal textarea.form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
    }

    .review-modal textarea.form-control {
      resize: none;
      min-height: 100px;
    }

    .review-modal .modal-footer {
      border-top: 1px solid silver;
      background-color: #f9f9f9;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
    }

    .review-modal .btn-success {
      background-color: #28a745;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .review-modal .btn-success:hover {
      background-color: #218838;
      transform: translateY(-1px);
    }

    .review-modal .btn-secondary {
      background-color: #6c757d;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .review-modal .btn-secondary:hover {
      background-color: #5a6268;
      transform: translateY(-1px);
    }

    .review-modal.modal.fade .modal-dialog {
      transform: scale(0.9);
      transition: transform 0.25s ease-out;
    }

    .review-modal.modal.fade.show .modal-dialog {
      transform: scale(1);
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 99999;
    }

    .toast-msg {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 6px;
      min-width: 240px;
      font-size: 0.9rem;
      color: #000;
      background: #e0e0e0;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transform: translateY(-10px);
      animation: toast-in 0.3s ease forwards, toast-out 0.5s ease 4s forwards;
      border-left: 4px solid #eee9e9;
    }

    .toast-success {
      background: #f5f5f5;
      color: #000;
      border-left-color: #a0a0a0;
    }

    .toast-warning {
      background: #fafafa;
      color: #000;
      border-left-color: #c0c0c0;
    }

    .toast-danger,
    .toast-error {
      background: #dcdcdc;
      color: #000;
      border-left-color: #999;
    }

    .toast-info {
      background: #eeeeee;
      color: #000;
      border-left-color: #bbb;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toast-out {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

     .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 99999;
    }

    .toast-msg {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 6px;
      min-width: 240px;
      font-size: 0.9rem;
      color: #000;
      background: #e0e0e0;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transform: translateY(-10px);
      animation: toast-in 0.3s ease forwards, toast-out 0.5s ease 4s forwards;
      border-left: 4px solid #eee9e9;
    }

    .toast-success {
      background: #f5f5f5;
      color: #000;
      border-left-color: #a0a0a0;
    }

    .toast-warning {
      background: #fafafa;
      color: #000;
      border-left-color: #c0c0c0;
    }

    .toast-danger,
    .toast-error {
      background: #dcdcdc;
      color: #000;
      border-left-color: #999;
    }

    .toast-info {
      background: #eeeeee;
      color: #000;
      border-left-color: #bbb;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toast-out {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

  </style>
</head>

<body>

  <!-- msg -->
  {% if messages %}
  <div class="toast-container">
    {% for message in messages %}
    <div class="toast-msg toast-{{ message.tags }}">
      <i
        class="fa-solid 
      {% if message.tags == 'success' %}fa-circle-check{% elif message.tags == 'warning' %}fa-triangle-exclamation
      {% elif message.tags == 'danger' or message.tags == 'error' %}fa-circle-xmark{% else %}fa-circle-info{% endif %}">
      </i>
      <span>{{ message }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <div class="container my-5">

    <!-- Profile  -->
    <div class="profile-header">
      {% if user.profile.image and user.profile.image.url %}
      <img src="{{ user.profile.image.url }}" alt="Profile">
      {% else %}
      <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar">
      {% endif %}

      <div class="info">
       <h4>
    {% if user.get_full_name %}
        {{ user.get_full_name }}
    {% else %}
        {{ user.username }}
    {% endif %}
</h4>

        <p>{{ user.email }}</p>
        <button class="edit-btn" data-bs-toggle="modal" data-bs-target="#editProfileModal">
          <i class="bi bi-pencil-square me-1"></i> Edit Profile
        </button>
        <a href="{% url 'home' %}" class="edit-btn">
          <i class="bi bi-house"></i> Home
        </a>

      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-5" id="profileTabs">
      <li class="nav-item"><a
          class="nav-link {% if active_tab == 'account' %}{% elif not active_tab %}{% else %}{% endif %}"
          data-bs-toggle="tab" href="#account">Account Info</a></li>
      <li class="nav-item"><a class="nav-link {% if active_tab == 'bookings' or not active_tab %}active{% endif %}"
          data-bs-toggle="tab" href="#bookings">My Bookings</a></li>
      <li class="nav-item"><a class="nav-link {% if active_tab == 'wishlist' %}active{% endif %}" data-bs-toggle="tab"
          href="#wishlist">Wishlist</a></li>
      <li class="nav-item"><a class="nav-link {% if active_tab == 'password' %}active{% endif %}" data-bs-toggle="tab"
          href="#password">Change Password</a></li>
    </ul>



    <!-- Tab Content -->
    <div class="tab-content pt-4">

      <!-- Account Info -->
      <div class="tab-pane fade" id="account">
        <div class="card p-4">
          <h5>Account Information</h5>
          <p><strong>Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Username:</strong> {{ user.username }}</p>
        </div>
      </div>

      <!-- My Bookings -->
      <div class="tab-pane fade {% if active_tab == 'bookings' or not active_tab %}show active{% endif %}"
        id="bookings">
        <div class="card my-bookings p-4">
          <h5>My Bookings</h5>

          <div class="filter-buttons mb-3">
            <a href="?status=all" class="btn btn-outline-light {% if active_filter == 'all' %}active{% endif %}">All</a>
            <a href="?status=pending"
              class="btn btn-outline-light  {% if active_filter == 'pending' %}active{% endif %}">Pending</a>
            <a href="?status=approved"
              class="btn btn-outline-light {% if active_filter == 'approved' %}active{% endif %}">Approved</a>
            <a href="?status=cancelled"
              class="btn btn-outline-light {% if active_filter == 'cancelled' %}active{% endif %}">Cancelled</a>
            <a href="?status=completed"
              class="btn btn-outline-light {% if active_filter == 'completed' %}active{% endif %}">Completed</a>
          </div>


          {% if bookings %}
    <div class="bookings-list">
      {% for booking in bookings %}
      <div class="booking-item">

        <!-- Car / Service Image -->
        <div class="car-image">
          {% if booking.car %}
            {% if booking.car.image %}
              <img src="{{ booking.car.image.url }}" alt="{{ booking.car.name }}">
            {% else %}
              <img src="{% static 'images/default_car.jpg' %}" alt="Car image">
            {% endif %}
          {% elif booking.service %}
            {% if booking.service.image %}
              <img src="{{ booking.service.image.url }}" alt="{{ booking.service.name }}">
            {% else %}
              <img src="{% static 'images/default_service.jpg' %}" alt="Service image">
            {% endif %}
          {% else %}
            <img src="{% static 'images/default_item.jpg' %}" alt="Item image">
          {% endif %}
        </div>

        <!-- Booking Info -->
        <div class="booking-details flex-grow-1 ps-4 pe-4">
          <h5 class="car-name mb-2">{{ booking.car.name }}</h5>
          <p class="mb-1"><strong>Type:</strong> {{ booking.get_booking_type_display }}</p>
          <p class="mb-1"><strong>Date:</strong> {{ booking.date }}</p>
          <p class="mb-1"><strong>Time:</strong> {{ booking.time|default:"-" }}</p>
          <p class="mb-1"><strong>Duration:</strong> {{ booking.duration|default:"-" }}</p>
          <p class="mb-1"><strong>Advance Payment:</strong> ₹{{ booking.advance_payment|default:"0.00" }}</p>
          <p class="mb-1"><strong>Status:</strong>
            <span class="badge
         {% if booking.status == 'Approved' %}
          bg-success
          {% elif booking.status == 'Pending' %}
        bg-warning text-dark
         {% elif booking.status == 'Cancelled by Admin' %}
         bg-danger
           {% elif booking.status == 'Cancelled by User' %}
        {% if booking.get_booking_type_display == "Test Drive" %}
        bg-danger   
          {% else %}
        bg-warning text-dark  
             {% endif %}
          {% else %}
             bg-secondary
        {% endif %}">
      {% if booking.status == 'Cancelled by User' %}
        {% if booking.get_booking_type_display == "Test Drive" %}
            Cancelled
        {% else %}
            Refund Pending
        {% endif %}
            {% else %}
        {{ booking.status }}
            {% endif %}
           </span>

          </p>
          <p class="mb-0"><strong>Details:</strong>
            {% if booking.car %}
              <a href="{% url 'car_details' car_id=booking.car.id %}" class="details-btn"><i class="bi bi-eye"></i></a>
            {% elif booking.service %}
              <a href="{% url 'service_detail' service_id=booking.service.id %}" class="details-btn"><i class="bi bi-eye"></i></a>
            {% else %}
              <span>No details available</span>
            {% endif %}
          </p>

          <!-- ⭐ Review Button -->
          {% if booking.status == 'Completed' %}
            {% if booking.id in reviewed_booking_ids %}
              <button class="btn btn-secondary btn-sm mt-2" disabled>Reviewed</button>
            {% else %}
              <button class="btn btn-success btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#reviewModal{{ booking.id }}">Give Review</button>
            {% endif %}
          {% endif %}
        </div>

        <!-- Actions: Cancel + Remove -->
        <div class="booking-action text-end mt-3">

          <!-- Cancel Button / Refund Logic -->
          {% if booking.status in 'Pending,Approved' and booking.get_booking_type_display != "test_drive" %}
            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal{{ booking.id }}">
              Cancel Booking
            </button>

            <!-- Cancel Modal -->
            <div class="modal fade" id="cancelModal{{ booking.id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ booking.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content bg-dark text-light">
                  <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel{{ booking.id }}">Cancel Booking
                      {% if booking.car %}{{ booking.car.name }}{% elif booking.service %}{{ booking.service.name }}{% endif %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form action="{% url 'delete_booking_user' booking.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="reason{{ booking.id }}" class="form-label">Reason for cancellation</label>
                        <textarea class="form-control" id="reason{{ booking.id }}" name="cancel_reason" rows="3" required></textarea>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-danger">Confirm Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Remove Booking (always available) -->
          <form action="{% url 'remove_booking_user' booking.id %}" method="POST" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger mx-2">Remove</button>
          </form>

        </div>
      </div>

      <!-- ⭐ Review Modal -->
      <div class="modal fade review-modal" id="reviewModal{{ booking.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                Review for
                {% if booking.car %}{{ booking.car.name }}
                {% elif booking.service %}{{ booking.service.name }}
                {% else %}Booking #{{ booking.id }}
                {% endif %}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="POST" action="{% url 'submit_review' booking.id %}">
              {% csrf_token %}
              <div class="modal-body">
                <label class="form-label">Rating</label>
                <select name="rating" class="form-select" required>
                  <option value="">Select rating</option>
                  <option value="5">⭐⭐⭐⭐⭐</option>
                  <option value="4">⭐⭐⭐⭐</option>
                  <option value="3">⭐⭐⭐</option>
                  <option value="2">⭐⭐</option>
                  <option value="1">⭐</option>
                </select>

                <label class="form-label mt-3">Comment</label>
                <textarea name="comment" class="form-control" placeholder="Write your review..."></textarea>
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Submit Review</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% endfor %}
    </div>
    {% else %}
      <p class="text-muted">You have no bookings yet</p>
    {% endif %}

          <!-- SPARE PART BOOKINGS -->
          <div class="divider mt-4 mb-3"></div>

          <h5 class="mt-3">Spare Part Bookings</h5>

          {% if spare_bookings %}
          <div class="bookings-list">
            {% for booking in spare_bookings %}
            {% if booking.status in "booked,delivered,Cancelled by User,Refunded" %}
            <div class="booking-item d-flex justify-content-between align-items-start">

              <div class="booking-details flex-grow-1 ps-2 pe-2">
                <h5 class="car-name mb-2">{{ booking.part.name }}</h5>

                <p class="mb-1"><strong>Booked On:</strong>
                  {{ booking.created_at|date:"M d, Y - h:i A" }}
                </p>

                <p class="mb-1"><strong>Quantity:</strong> {{ booking.quantity }}</p>
                <p class="mb-1"><strong>Unit Price:</strong> ₹{{ booking.part.price }}</p>
                <p class="mb-1"><strong>Total:</strong> ₹{{ booking.amount }}</p>

                <p class="mb-1"><strong>Mode:</strong>
                  {% if booking.payment_method == 'cod' %}
                  Cash on Delivery
                  {% else %}
                  Online Payment
                  {% endif %}
                </p>

                <p class="mb-1"><strong>Status:</strong>
                  {% if booking.status == "booked" %}
    <span class="badge bg-warning text-dark">Booked</span>

{% elif booking.status == "delivered" %}
    <span class="badge bg-success">Delivered</span>

{% elif booking.status == "Cancelled by User" and booking.payment_method == "online" %}
    <span class="badge bg-warning text-dark">Refund Pending</span>

{% elif booking.status == "Cancelled by User" and booking.payment_method == "cod" %}
    <span class="badge bg-danger">Cancelled</span>

{% elif booking.is_refunded %}
    <span class="badge bg-success">Refunded</span>

{% else %}
    <span class="badge bg-secondary">Unknown</span>
{% endif %}

                </p>

                <!-- ⭐ Review Button -->
                {% if booking.status == 'delivered' %}
                {% if booking.id in reviewed_spare_ids %}
                <button class="btn btn-secondary btn-sm mt-2" disabled>Reviewed</button>
                {% else %}
                <button class="btn btn-success btn-sm mt-2" data-bs-toggle="modal"
                  data-bs-target="#spareReviewModal{{ booking.id }}">
                  Give Review
                </button>
                {% endif %}
                {% endif %}

                <!-- ⭐ Review Modal -->
                <div class="modal fade" id="spareReviewModal{{ booking.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">

                      <div class="modal-header">
                        <h5 class="modal-title text-dark">
                          Review for {{ booking.part.name }}
                        </h5>
                      </div>

                      <form method="POST" action="{% url 'submit_spare_review' booking.id %}">
                        {% csrf_token %}
                        <div class="modal-body">

                          <label class="form-label text-dark">Rating</label>
                          <select name="rating" class="form-select" required>
                            <option value="">Select rating</option>
                            <option value="5">⭐⭐⭐⭐⭐</option>
                            <option value="4">⭐⭐⭐⭐</option>
                            <option value="3">⭐⭐⭐</option>
                            <option value="2">⭐⭐</option>
                            <option value="1">⭐</option>
                          </select>

                          <label class="form-label mt-3 text-dark">Comment</label>
                          <textarea name="comment" class="form-control" placeholder="Write your review..."></textarea>

                        </div>

                        <div class="modal-footer">
                          <button type="submit" class="btn btn-success">Submit Review</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                      </form>

                    </div>
                  </div>
                </div>

              </div>
              <!-- delete -->
<div class="booking-action text-end">
    {% if booking.status == "booked" %}
    <!-- Cancel button (only if booked) -->
    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
            data-bs-target="#cancelModal{{ booking.id }}">
        Cancel Booking
    </button>

        <!-- Modal -->
        <div class="modal fade" id="cancelModal{{ booking.id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ booking.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="cancelModalLabel{{ booking.id }}">Cancel Booking #{{ booking.part.name }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form action="{% url 'spare_booking_delete' booking.id %}" method="POST">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="reason{{ booking.id }}" class="form-label">Reason for cancellation</label>
                                <textarea class="form-control" id="reason{{ booking.id }}" name="cancel_reason" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-danger">Confirm Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

{% endif %}

    <!-- Remove Booking (always available) -->
          <form action="{% url 'remove_spare_booking_user' booking.id %}" method="POST" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger mx-2">Remove</button>
          </form>
</div>

            </div>
            {% endif %}
            {% endfor %}

          </div>

          {% else %}
          <p class="text-muted">You have no spare part bookings yet.</p>
          {% endif %}
        </div>

      </div>

      <!-- Wishlist -->
      <div class="tab-pane fade {% if active_tab == 'wishlist' %}show active{% endif %}" id="wishlist">
        <div class="card p-4">
          <h5>My Wishlist</h5>

          {% if wishlist_items %}
          <div class="row g-3">
            {% for item in wishlist_items %}
            <div class="col-md-3">
              <div class="card h-100 text-center p-2 shadow-sm">
                <img src="{{ item.car.image.url }}" class="card-img-top rounded" alt="{{ item.car.name }}">
                <div class="card-body">
                  <h6 style="color: white;">{{ item.car.name }}</h6>
                  <p class="text-muted">₹{{ item.car.price }}</p>

                  <div class="d-flex justify-content-between align-items-center mt-2">
         
                    <a href="{% url 'car_details' item.car.id %}" class="details-btn">
                      <i class="bi bi-eye"></i>
                    </a>

               
                    <button class="wishlist-heart-btn btn p-0" data-car-id="{{ item.car.id }}">
                      <i class="bi bi-heart-fill text-danger fs-5"></i>
                    </button>
                  </div>

                </div>
              </div>
            </div>
            {% endfor %}

          </div>
          {% else %}
          <p class="text-muted">No items in your wishlist.</p>
          {% endif %}

        </div>
      </div>


      <!-- Change Password -->
      <div class="tab-pane fade {% if active_tab == 'password' %}show active{% endif %}" id="password">
        <div class="card p-4">
          <h5>Change Password</h5>

          <!-- Success / Error messages -->
          {% if messages %}
          {% for message in messages %}
          {% if 'password-success' in message.tags %}
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" data-bs-dismiss="alert" aria-label="Close" id="close_btn">x</button>
          </div>
          {% elif 'password-error' in message.tags %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" data-bs-dismiss="alert" aria-label="Close" id="close_btn">x</button>
          </div>
          {% endif %}
          {% endfor %}
          {% endif %}

          <form method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              {{ form.old_password }}
              {% if form.old_password.errors %}
              <div class="text-danger small">{{ form.old_password.errors|striptags }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label">New Password</label>
              {{ form.new_password1 }}
              {% if form.new_password1.errors %}
              <div class="text-danger small">{{ form.new_password1.errors|striptags }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              {{ form.new_password2 }}
              {% if form.new_password2.errors %}
              <div class="text-danger small">{{ form.new_password2.errors|striptags }}</div>
              {% endif %}
            </div>

            <button type="submit" class="btn btn-outline-primary px-4" id="update-btn">Update</button>
          </form>
        </div>
      </div>
    </div>

  </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title">Edit Profile</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'edit_profile' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">First Name</label>
              <input type="text" name="first_name" value="{{ user.first_name }}" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Last Name</label>
              <input type="text" name="last_name" value="{{ user.last_name }}" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" name="email" value="{{ user.email }}" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Profile Image</label>
              <input type="file" name="image" class="form-control">
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-outline-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>



  <script>
    // filter tab
    document.addEventListener('DOMContentLoaded', function () {

      const urlParams = new URLSearchParams(window.location.search);
      const activeTab = urlParams.get('tab');

      if (activeTab) {
        const triggerEl = document.querySelector(`#profileTabs a[href="#${activeTab}"]`);
        if (triggerEl) {
          const tab = new bootstrap.Tab(triggerEl);
          tab.show();
        }
      }

      document.querySelectorAll('#profileTabs a').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
          const tabId = event.target.getAttribute('href').substring(1);
          const newUrl = `${window.location.pathname}?tab=${tabId}`;
          window.history.replaceState(null, '', newUrl);
        });
      });
    });


    // delete
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const bookingId = btn.getAttribute('data-booking-id');
        if (confirm('Are you sure you want to delete this booking?')) {
          const response = await fetch(`/delete-booking/${bookingId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/json'
            }
          });
          if (response.ok) {
            btn.closest('.booking-item').remove();
          } else {
            alert('Error deleting booking. Please try again.');
          }
        }
      });
    });


    // wishlist
    document.querySelectorAll('.wishlist-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const carId = this.dataset.carId;
        const icon = this.querySelector('i');

        fetch(`/wishlist/toggle/${carId}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
        })
          .then(res => res.json())
          .then(data => {

            if (data.status === 'added') {
              icon.classList.remove('bi-heart');
              icon.classList.add('bi-heart-fill', 'text-danger');
            } else {
              icon.classList.remove('bi-heart-fill', 'text-danger');
              icon.classList.add('bi-heart');
            }


            icon.classList.add('heart-pop');
            icon.addEventListener('animationend', () => {
              icon.classList.remove('heart-pop');
            }, { once: true });
          });
      });
    });


    // remove wishlist
    document.querySelectorAll('.wishlist-heart-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const carId = this.dataset.carId;
        const card = this.closest('.col-md-3');

        fetch(`/wishlist/toggle/${carId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          }
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'removed') {
              card.remove();
            }
          });
      });
    });

    // toast msg
    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(() => {
        document.querySelectorAll(".toast-msg").forEach(toast => toast.remove());
      }, 5000);
    });

  </script>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>