{% extends "dashboard_base.html" %}
{% load humanize %}
{% load custom_filters %}
{% block content %}

<style>
  .divider {
    background-color: #333;
    height: 2px;
    margin-bottom: 15px;
    border-radius: 2px;
  }

  .stats-container .row>div {
    flex: 0 0 33.333%;
    max-width: 33.333%;
  }

  .stats-container .card {
    height: 130px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .table-responsive {
    width: 100%;
    overflow-x: auto;
    border-radius: 10px;
  }

  .table {
    width: 100%;
    min-width: 700px;
    border-collapse: collapse;
    background-color: #1e1e1e;
    color: #f1f1f1;
    font-size: 0.85rem;
  }

  .table th,
  .table td {
    padding: 6px 10px;
    text-align: left;
    border-bottom: 1px solid #2e2e2e;
    white-space: nowrap;
  }

  .table th {
    background-color: #2c2c2c;
    font-weight: 500;
    color: #fff;
  }

  .table tbody tr:hover {
    background-color: #2a2a2a;
  }

.btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.btn-group .btn {
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 6px;
    border: 1px solid #555;
    color: #fff;
    background-color: transparent;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-group .btn:hover {
    background-color: #444;
    border-color: #888;
    color: #fff;
}

.btn-group .btn.active {
    background-color: #ffc107;
    color: #000;
    border-color: #ffc107;
}

@media (max-width: 576px) {
    .btn-group .btn {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
}

.btn-group .btn {
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

  @media (max-width: 768px) {
    .stats-container .row>div {
      flex: 0 0 50%;
      max-width: 50%;
    }
  }

  @media (max-width: 576px) {
    .stats-container .row>div {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }

  @media (max-width: 576px) {

    .table th,
    .table td {
      padding: 4px 6px;
      font-size: 0.75rem;
    }

    .table {
      min-width: 600px;
    }

  }

 @media print {
  body * {
    visibility: hidden;
  }
  .table-responsive, .table-responsive * {
    visibility: visible;
  }
  .table-responsive {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    overflow: visible !important; 
  }

  .table {
    font-size: 12pt;
  }
}


</style>

<div class="container py-4 mt-5">

  <div class="page-header">
    <h2>Reports</h2>
    {% include "accounts/_top_icons.html" %}
    <a href="{% url 'admin_dashboard' %}"><i class="fa-solid fa-arrow-left"></i></a>
  </div>

  <div class="divider"></div>

<!-- pdf,excel,print -->
  <div class="d-flex gap-2 mb-3">
    <button id="exportPdf" class="btn btn-danger">
        <i class="fa-solid fa-file-pdf"></i> PDF
    </button>
    <button id="exportExcel" class="btn btn-success">
        <i class="fa-solid fa-file-excel"></i> Excel
    </button>
    <button onclick="window.print()" class="btn btn-primary">
        <i class="fa-solid fa-print"></i> Print
    </button>
</div>


  <!-- table -->
 <div class="btn-group mt-3 mb-3" role="group">
    <a href="?filter=all" class="btn {% if current_filter == 'all' %}active{% endif %}">All</a>
    <a href="?filter=bookings" class="btn {% if current_filter == 'bookings' %}active{% endif %}">Car Bookings</a>
    <a href="?filter=payments" class="btn {% if current_filter == 'payments' %}active{% endif %}">Payments</a>
    <a href="?filter=staff" class="btn {% if current_filter == 'staff' %}active{% endif %}">Staff</a>
    <a href="?filter=customers" class="btn {% if current_filter == 'customers' %}active{% endif %}">Customers</a>
    <a href="?filter=services" class="btn {% if current_filter == 'services' %}active{% endif %}">Services</a>
    <a href="?filter=test_drive" class="btn {% if current_filter == 'test_drive' %}active{% endif %}">Test Drives</a>
</div>

 <div class="table-responsive mt-4">
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                {% if current_filter == "bookings" or current_filter == "payments" or current_filter == "test_drive" or current_filter == "services" or current_filter == "all" %}
                    <th>Type</th>
                    <th>Car / Service</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Total</th>
                    <th>Advance</th>
                    <th>Balance</th>
                    <th>Status</th>
                {% else %}
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined Date</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in last_data %}
            <tr>
                <td>{{ forloop.counter }}</td>
                {% if current_filter == "customers" or current_filter == "staff" %}
                    <td>{{ item.get_full_name|default:item.username }}</td>
                    <td>{{ item.email }}</td>
                    <td>{{ item.role|title }}</td> 
                    <td>{{ item.date_joined|date:"d M Y" }}</td>
                {% else %}
                    <td>{{ item.user.get_full_name|default:item.user.username }}</td>
                    <td>{{ item.booking_type|pretty_label }}</td>
                    <td>
                        {% if item.car %}
                            {{ item.car.name }}
                        {% elif item.service %}
                            {{ item.service.name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ item.date|date:"d M Y" }}</td>
                    <td>{{ item.time }}</td>
                    <td>₹{{ item.price|floatformat:2|intcomma }}</td>
                    <td>₹{{ item.advance_payment|floatformat:2|intcomma }}</td>
                    <td>₹{{ item.balance|floatformat:2|intcomma }}</td>
                    <td>{{ item.status }}</td>
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if current_filter == 'customers' or current_filter == 'staff' %}4{% else %}12{% endif %}" class="text-center">No data found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


  <!-- Summary Cards -->
  <div class="stats-container">
    <div class="row g-4 mb-4 mt-4">
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Cars</h6>
          <h3>{{ total_cars }}</h3>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Services</h6>
          <h3>{{ total_services }}</h3>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Staff</h6>
          <h3>{{ total_staff }}</h3>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Customers</h6>
          <h3>{{ total_customers }}</h3>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Bookings</h6>
          <h3>{{ total_bookings }}</h3>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3 bg-dark text-white">
          <h6>Total Revenue</h6>
          <h3>₹{{ total_revenue|floatformat:2|intcomma }}</h3>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <!-- Charts Section -->
  <div class="row g-4 mb-4 chart-row">

    <!-- Bookings per Day -->
    <div class="col-md-6">
      <div class="card p-3 bg-dark text-white">
        <h6>Bookings per Day</h6>
        <hr>
        <canvas id="bookingChart"></canvas>
      </div>
    </div>
  </div>

  <hr>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- SheetJS for Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<!-- Django data as JSON -->
{{ daily_bookings_data|json_script:"daily_bookings_data" }}

<script>
  const dailyData = JSON.parse(document.getElementById('daily_bookings_data').textContent);
  const bookingCtx = document.getElementById('bookingChart').getContext('2d');
  new Chart(bookingCtx, {
    type: 'bar',
    data: {
      labels: dailyData.labels,
      datasets: [
        {
          label: 'Advance Paid',
          data: dailyData.advance,
          backgroundColor: '#ffc107',
        },
        {
          label: 'Balance',
          data: dailyData.balance,
          backgroundColor: '#28a745',
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { color: '#fff' } }
      },
      scales: {
        x: { ticks: { color: '#fff' }, stacked: true },
        y: { ticks: { color: '#fff' }, stacked: true }
      }
    }
  });

</script>


<script>
  // Export PDF
  document.getElementById('exportPdf').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("Reports", 14, 20);

    const table = document.querySelector('.table'); 
    const rows = [];
    for (let i = 0; i < table.rows.length; i++) {
      const row = [];
      for (let j = 0; j < table.rows[i].cells.length; j++) {
        row.push(table.rows[i].cells[j].innerText);
      }
      rows.push(row);
    }

    doc.autoTable({
      head: [rows[0]],
      body: rows.slice(1),
      startY: 30
    });

    doc.save('report.pdf');
  });

  // Export Excel
  document.getElementById('exportExcel').addEventListener('click', () => {
    const table = document.querySelector('.table');
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "Reports");
    XLSX.writeFile(wb, "report.xlsx");
  });
</script>


{% endblock %}